<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="container" style="width:100%;height: 70vh;"></div>
    <script src="//webapi.amap.com/loader.js"></script>
    <script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode:'81f0fb73b22ad5fc3cf1fb8cd3842ab4',
    }
    window.resultList = []
    window.fullResultList = []
    window.cityPicker = null
    window.curCityName = ''
    window.curCityCode = ''
    var point = {
        lng: '',
        lat: ''
    }
    var longitude = ''
    var latitude = ''

    function handlePositionPicker(map, PositionPicker, SimpleInfoWindow) {
			const positionPicker = new PositionPicker({
				mode: 'dragMap',// 设定为拖拽地图模式，可选'dragMap'、'dragMarker'，默认为'dragMap'
				map: map, // 依赖地图对象
				iconStyle: { //自定义外观
					url: '//webapi.amap.com/ui/1.0/assets/position-picker2.png',
					ancher: [24, 40],
					size: [40, 40]
				}
			});
			positionPicker.start([point.lng, point.lat]);
			// 选址结束后的回调函数
			positionPicker.on('success', res => {
				const infoWindow = new SimpleInfoWindow({
					infoTitle: res.name,
					infoBody: res.address,
					offset: new AMap.Pixel(0, -37)
				});
				//显示在map上
				infoWindow.open(map, res.position);
				if (res.regeocode && res.regeocode.pois) {
					window.fullResultList = res.regeocode.pois
					const resultList = [{
						address: res.nearestJunction,
						businessArea: '',
						distance: 0,
						location: [res.position.lng, res.position.lat],
						name: res.address
					}].concat(window.fullResultList)
					if (resultList.length > 1) {
						const name0 = resultList[0].name
						const name1 = resultList[1].name
						name0.indexOf(name1) > -1 && resultList.splice(0, 1)
						resultList[0].name = '[当前]' + resultList[0].name
						window.resultList = resultList
					}
				} else {
					window.fullResultList = []
				}
			})
			positionPicker.on('fail', res => {
				console.log(res)
			})
		}
    function handleCityPicker(MobiCityPicker, map) {
        window.cityPicker = new MobiCityPicker({
            //设置主题（同名的className会被添加到外层容器上）
            theme: "light",
            //topGroups: ..., // 顶部城市列表
        });
        //监听城市选中事件
        window.cityPicker.on("citySelected", (cityInfo) => {
            cityPicker.hideImmediately();  //立即隐藏
            console.log(cityInfo);        //选中的城市信息
            const { adcode, name, lat, lng } = cityInfo
            window.curCityName = name
            window.curCityCode = adcode
            // map.setCenter([lng, lat])
        });
    }
    function initMap() {
        AMapLoader.load({
            "key": "2c59eafa7a7a18132c8b4b44dcb1f740",              // 申请好的Web端开发者Key，首次调用 load 时必填
            "version": "2.0",       // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15
            "plugins": [
                'AMap.Geolocation',
                'AMap.CitySearch',
                'AMap.AutoComplete'
            ],
            "Loca": {                // 是否加载 Loca， 缺省不加载
                "version": '2.0.0'  // Loca 版本，缺省 1.3.2
            },
        }).then(async (AMap) => {
            await new Promise((resolve, reject) => {
				if (window.AMapUI) {
					resolve(window.AMapUI)
				} else {
					const scriptUI = document.createElement('script')
					scriptUI.type = 'text/javascript'
					scriptUI.src = '//webapi.amap.com/ui/1.1/main.js?v=1.1.1'
					scriptUI.onerror = reject

					scriptUI.onload = function (su) {
						resolve(window.AMapUI)
					};
					document.body.appendChild(scriptUI)
				}
			})
            var map = new AMap.Map('container', {
                zoom: 16,
                scrollWheel: true
            })
            window.map = map
            AMapUI.loadUI([
                'misc/PositionPicker',
                'misc/MobiCityPicker',
                'overlay/SimpleInfoWindow'
            ], (
                PositionPicker,
                MobiCityPicker,
                SimpleInfoWindow
            ) => {
                handlePositionPicker(map, PositionPicker, SimpleInfoWindow)
                handleCityPicker(MobiCityPicker, map)
            });
            const geolocation = new AMap.Geolocation({
                // 是否使用高精度定位，默认：true
                enableHighAccuracy: true,
                // 设置定位超时时间，默认：无穷大
                timeout: 10000,
                position: 'RB',
                showButton: true,
                panToLocation: true,
                zoomToAccuracy: true
            })
            map.addControl(geolocation);
            if (point && point.lng) {
                // 有初始值, 逆向地理编码查询地理位置详细信息
                AMap.plugin('AMap.Geocoder', () => {
                    const geocoder = new AMap.Geocoder();
                    const lnglat = [point.lng, point.lat];
                    geocoder.getAddress(lnglat, (status, data) => {
                        if (status === 'complete' && data.info === 'OK') {
                            // result为对应的地理位置详细信息
                            const addressComponent = data?.regeocode?.addressComponent
                            curCityName = addressComponent.city || addressComponent.province;
                            curCityCode = addressComponent.adcode;
                        }
                    })
                })
            } else {
                // 没有初始值，进行IP城市查询
                geolocation.getCurrentPosition((status, result) => {
                    if (status == 'complete') {
                        point = {
                            lng: result.position.lng,
                            lat: result.position.lat
                        };
                        AMap.plugin('AMap.Geocoder', () => {
                            const geocoder = new AMap.Geocoder();
                            const lnglat = [point.lng, point.lat];
                            geocoder.getAddress(lnglat, (status, data) => {
                                    if (status === 'complete' && data.info === 'OK') {
                                            // result为对应的地理位置详细信息
                                            const addressComponent = data?.regeocode?.addressComponent
                                            curCityName = addressComponent.city || addressComponent.province;
                                            curCityCode = addressComponent.adcode;
                                    }
                                    console.log(point.lng)
                                    console.log(point.lat)
                                    positionPicker.start([point.lng, point.lat]);
                            })
                        })
                    } else {
                        getLngLatLocation()
                    }
                });
            }
        }).catch((e)=>{
            console.error(e);  //加载错误提示
        });
    }
    initMap();
    </script>
    <!-- <script src="//webapi.amap.com/ui/1.1/main.js"></script> -->
</body>
</html>